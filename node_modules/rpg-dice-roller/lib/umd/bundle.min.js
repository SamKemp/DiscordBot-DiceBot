/**
 * rpg-dice-roller - An advanced JS based dice roller that can roll various types of dice and modifiers, along with mathematical equations.
 * 
 * @version 5.0.0
 * @license MIT
 * @author GreenImp <info@greenimp.co.uk> (http://greenimp.co.uk)
 * @link https://greenimp.github.io/rpg-dice-roller/
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mathjs"),require("random-js")):"function"==typeof define&&define.amd?define(["exports","mathjs","random-js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).rpgDiceRoller={},t.math,t.Random)}(this,(function(t,e,r){"use strict";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function a(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}function u(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function f(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function h(t,e,r){return(h=f()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var o=new(Function.bind.apply(t,n));return r&&l(o,r.prototype),o}).apply(null,arguments)}function p(t){var e="function"==typeof Map?new Map:void 0;return(p=function(t){if(null===t||(r=t,-1===Function.toString.call(r).indexOf("[native code]")))return t;var r;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return h(t,arguments,c(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),l(n,t)})(t)}function y(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function m(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?y(t):e}function v(t){var e=f();return function(){var r,n=c(t);if(e){var o=c(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return m(this,r)}}function d(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t}function g(t,e,r){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var n=d(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(r):o.value}})(t,e,r||t)}function b(t,e,r,n){return(b="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,r,n){var o,i=d(t,e);if(i){if((o=Object.getOwnPropertyDescriptor(i,e)).set)return o.set.call(n,r),!0;if(!o.writable)return!1}if(o=Object.getOwnPropertyDescriptor(n,e)){if(!o.writable)return!1;o.value=r,Object.defineProperty(n,e,o)}else u(n,e,r);return!0})(t,e,r,n)}function w(t,e,r,n,o){if(!b(t,e,r,n||t)&&o)throw new Error("failed to set property");return r}function k(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var r=[],n=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){o=!0,i=t}finally{try{n||null==u.return||u.return()}finally{if(o)throw i}}return r}(t,e)||A(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(t){return function(t){if(Array.isArray(t))return E(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||A(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function A(t,e){if(t){if("string"==typeof t)return E(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?E(t,e):void 0}}function E(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var x=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),n=e.call(this,'Operator "'.concat(t,'" is invalid')),TypeError.captureStackTrace&&TypeError.captureStackTrace(y(n),r),n.name="CompareOperatorError",n.operator=t,n}return r}(p(TypeError)),O=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),n=e.call(this,"Invalid data format: ".concat(t)),Error.captureStackTrace&&Error.captureStackTrace(y(n),r),n.name="ImportError",n.data=t,n}return r}(p(Error)),T=function(t){s(r,t);var e=v(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return o(this,r),n=e.call(this,'Die "'.concat(t,'" must have more than 1 possible value to ').concat(i||"do this action")),Error.captureStackTrace&&Error.captureStackTrace(y(n),r),n.name="DieActionValueError",n.action=i,n.die=t,n}return r}(p(Error)),C=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),n=e.call(this,'Notation "'.concat(t,'" is invalid')),Error.captureStackTrace&&Error.captureStackTrace(y(n),r),n.name="NotationError",n.notation=t,n}return r}(p(Error)),R=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return o(this,r),t=e.call(this,"Missing argument".concat(n?' "'.concat(n,'"'):"")),Error.captureStackTrace&&Error.captureStackTrace(y(t),r),t.argumentName=n,t}return r}(p(Error)),N=Object.freeze({__proto__:null,CompareOperatorError:x,DataFormatError:O,DieActionValueError:T,NotationError:C,RequiredArgumentError:R}),j=function(t){return e.evaluate(t)},P=function(t){return("number"==typeof t||"string"==typeof t)&&(!Number.isNaN(t)&&Number.isFinite(Number(t)))},M=function(t){if(!P(t))return!1;var e=Number(t);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER},F=Symbol("engine"),J=Symbol("random"),_={browserCrypto:r.browserCrypto,nodeCrypto:r.nodeCrypto,MersenneTwister19937:r.MersenneTwister19937,nativeMath:r.nativeMath,min:{next:function(){return 0}},max:{range:[],next:function(){return this.range[1]-this.range[0]}}},I=new(function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.nativeMath;o(this,t),this.engine=e||r.nativeMath}return a(t,[{key:"engine",get:function(){return this[F]},set:function(t){if(t&&"function"!=typeof t.next)throw new TypeError("engine must have function `next()`");this[F]=t||r.nativeMath,this[J]=new r.Random(this[F])}},{key:"integer",value:function(t,e){return this[F].range=[t,e],this[J].integer(t,e)}},{key:"real",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this[F].range=[t,e],this[J].real(t,e,r)}}]),t}()),q=Object.freeze({__proto__:null,engines:_,generator:I}),V=Symbol("operator"),D=Symbol("value"),B=function(){function t(e,r){if(o(this,t),!e)throw new R("operator");if(!r&&0!==r)throw new R("value");this.operator=e,this.value=r}return a(t,[{key:"operator",get:function(){return this[V]},set:function(t){if(!this.constructor.isValidOperator(t))throw new x(t);this[V]=t}},{key:"value",get:function(){return this[D]},set:function(t){if(!P(t))throw new TypeError("value must be a finite number");this[D]=Number(t)}},{key:"isMatch",value:function(t){return function(t,e,r){var n,o=Number(t),i=Number(e);if(Number.isNaN(o)||Number.isNaN(i))return!1;switch(r){case"=":case"==":n=o===i;break;case"<":n=o<i;break;case">":n=o>i;break;case"<=":n=o<=i;break;case">=":n=o>=i;break;case"!":case"!=":n=o!==i;break;default:n=!1}return n}(t,this.value,this.operator)}},{key:"toJSON",value:function(){return{operator:this.operator,type:"compare-point",value:this.value}}},{key:"toString",value:function(){return"".concat(this.operator).concat(this.value)}}],[{key:"isValidOperator",value:function(t){return"string"==typeof t&&/^(?:[<>!]?=|[<>])$/.test(t)}}]),t}(),G=function(){function t(){o(this,t),this.order=999}return a(t,[{key:"name",get:function(){return"modifier"}},{key:"notation",get:function(){return""}},{key:"maxIterations",get:function(){return 1e3}},{key:"run",value:function(t,e){return t}},{key:"toJSON",value:function(){var t=this.notation;return{name:this.name,notation:t,type:"modifier"}}},{key:"toString",value:function(){return this.notation}}]),t}(),z=Symbol("compare-point"),U=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),n=e.call(this),t&&(n.comparePoint=t),n}return a(r,[{key:"comparePoint",get:function(){return this[z]},set:function(t){if(!(t instanceof B))throw new TypeError("comparePoint must be instance of ComparePoint");this[z]=t}},{key:"name",get:function(){return"comparison"}},{key:"notation",get:function(){return"".concat(this.comparePoint||"")}},{key:"isComparePoint",value:function(t){return!!this.comparePoint&&this.comparePoint.isMatch(t)}},{key:"toJSON",value:function(){var t=this.comparePoint;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{comparePoint:t})}}]),r}(G),$=Symbol("compound"),K=Symbol("penetrate"),L=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o(this,r),(t=e.call(this,n))[$]=!!i,t[K]=!!a,t.order=3,t}return a(r,[{key:"compound",get:function(){return this[$]}},{key:"name",get:function(){return"explode"}},{key:"notation",get:function(){return"!".concat(this.compound?"!":"").concat(this.penetrate?"p":"").concat(g(c(r.prototype),"notation",this))}},{key:"penetrate",get:function(){return this[K]}},{key:"run",value:function(t,e){var r=this;if(e.min===e.max)throw new T(e,"explode");var n=t;return n.rolls=t.rolls.map((function(t){for(var n,o=[t],i=t.value,a=0;a<r.maxIterations&&r.isComparePoint(i);a++){var u=o[o.length-1],s=e.rollOnce();i=s.value,u.modifiers.add("explode"),r.penetrate&&(u.modifiers.add("penetrate"),s.value-=1),o.push(s)}return r.compound&&o.length>1?(t.value=(n=o.map((function(t){return t.value})),Array.isArray(n)?n.reduce((function(t,e){return t+(P(e)?parseFloat("".concat(e)):0)}),0):0),t.modifiers=["explode","compound"],r.penetrate&&t.modifiers.add("penetrate"),t):o})).flat(),n}},{key:"toJSON",value:function(){var t=this.compound,e=this.penetrate;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{compound:t,penetrate:e})}}]),r}(U),X={compound:"!",explode:"!","critical-failure":"__","critical-success":"**",drop:"d",max:"v",min:"^",penetrate:"p","re-roll":"r","re-roll-once":"ro","target-failure":"_","target-success":"*"},H=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return[].concat(e).reduce((function(t,e){var r;return r=e instanceof G?e.name:e,t+(X[r]||r)}),"")},Q=Symbol("calculation-value"),W=Symbol("modifiers"),Y=Symbol("initial-value"),Z=Symbol("use-in-total"),tt=Symbol("value"),et=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(o(this,t),P(e))this[Y]=Number(e),this.modifiers=r||[],this.useInTotal=i;else{if(!e||"object"!==n(e)||Array.isArray(e))throw e===1/0?new RangeError("Result value must be a finite number"):new TypeError("Result value is invalid: ".concat(e));var a=P(e.initialValue)?e.initialValue:e.value;if(!P(a))throw new TypeError("Result value is invalid: ".concat(a));this[Y]=Number(a),P(e.value)&&Number(e.value)!==this[Y]&&(this.value=e.value),P(e.calculationValue)&&parseFloat("".concat(e.calculationValue))!==this.value&&(this.calculationValue=e.calculationValue),this.modifiers=e.modifiers||r||[],this.useInTotal="boolean"==typeof e.useInTotal?e.useInTotal:i||!1}}return a(t,[{key:"calculationValue",get:function(){return P(this[Q])?parseFloat(this[Q]):this.value},set:function(t){var e=P(t);if(t===1/0)throw new RangeError("Result calculation value must be a finite number");if(t&&!e)throw new TypeError("Result calculation value is invalid: ".concat(t));this[Q]=e?parseFloat("".concat(t)):null}},{key:"initialValue",get:function(){return this[Y]}},{key:"modifierFlags",get:function(){return H.apply(void 0,S(this.modifiers))}},{key:"modifiers",get:function(){return this[W]},set:function(t){if((Array.isArray(t)||t instanceof Set)&&S(t).every((function(t){return"string"==typeof t})))this[W]=new Set(S(t));else{if(t||0===t)throw new TypeError("modifiers must be a Set or array of modifier names: ".concat(t));this[W]=new Set}}},{key:"useInTotal",get:function(){return!!this[Z]},set:function(t){this[Z]=!!t}},{key:"value",get:function(){return P(this[tt])?this[tt]:this[Y]},set:function(t){if(t===1/0)throw new RangeError("Result value must be a finite number");if(!P(t))throw new TypeError("Result value is invalid: ".concat(t));this[tt]=Number(t)}},{key:"toJSON",value:function(){var t=this.calculationValue,e=this.initialValue,r=this.modifierFlags,n=this.modifiers,o=this.useInTotal,i=this.value;return{calculationValue:t,initialValue:e,modifierFlags:r,modifiers:S(n),type:"result",useInTotal:o,value:i}}},{key:"toString",value:function(){return this.value+this.modifierFlags}}]),t}(),rt=Symbol("rolls"),nt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];o(this,t),this.rolls=e}return a(t,[{key:"length",get:function(){return this.rolls.length||0}},{key:"rolls",get:function(){return S(this[rt])},set:function(t){var e=this;if(!t||!Array.isArray(t))throw new TypeError("rolls must be an array: ".concat(t));this[rt]=[],t.forEach((function(t){e.addRoll(t)}))}},{key:"value",get:function(){return this.rolls.reduce((function(t,e){return t+(e.useInTotal?e.calculationValue:0)}),0)}},{key:"addRoll",value:function(t){var e=t instanceof et?t:new et(t);this[rt].push(e)}},{key:"toJSON",value:function(){return{rolls:this.rolls,type:"roll-results",value:this.value}}},{key:"toString",value:function(){return"[".concat(this.rolls.join(", "),"]")}}]),t}(),ot=Symbol("once"),it=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return o(this,r),(t=e.call(this,i)).once=!!n,t.order=4,t}return a(r,[{key:"name",get:function(){return"re-roll"}},{key:"notation",get:function(){return"r".concat(this.once?"o":"").concat(g(c(r.prototype),"notation",this))}},{key:"once",get:function(){return!!this[ot]},set:function(t){this[ot]=!!t}},{key:"run",value:function(t,e){var r=this;if(e.min===e.max)throw new T(e,"re-roll");return t.rolls.map((function(t){for(var n=0;n<r.maxIterations&&r.isComparePoint(t.value);n++){var o=e.rollOnce();if(t.value=o.value,t.modifiers.add("re-roll".concat(r.once?"-once":"")),r.once)break}return t})),t}},{key:"toJSON",value:function(){var t=this.once;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{once:t})}}]),r}(U),at=Symbol("modifiers"),ut=Symbol("qty"),st=Symbol("sides"),ct=Symbol("min-value"),lt=Symbol("max-value"),ft=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(o(this,t),!e&&0!==e)throw new R("sides");if(e===1/0)throw new RangeError("numerical sides must be finite number");if(P(e)){if(e<1||!M(e))throw new RangeError("numerical sides must be a positive finite number")}else if("string"!=typeof e)throw new TypeError("non-numerical sides must be a string");if(!P(r))throw new TypeError("qty must be a positive finite integer");if(r<1||r>999)throw new RangeError("qty must be between 1 and 999");if(!P(i))throw new TypeError("min must a finite number");if(!M(i))throw new RangeError("min must a finite number");if(a&&!P(a))throw new TypeError("max must a finite number");if(a&&!M(a))throw new RangeError("max must a finite number");this[ut]=parseInt("".concat(r),10),this[st]=e,n&&(this.modifiers=n),this[ct]=parseInt(i,10),this[lt]=a?parseInt("".concat(a),10):e}return a(t,[{key:"average",get:function(){return(this.min+this.max)/2}},{key:"modifiers",get:function(){return this[at]?new Map(S(this[at]).sort((function(t,e){return t[1].order-e[1].order}))):null},set:function(t){var e,r=this;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((function(t){return[t.name,t]})));else{if("object"!==n(t))throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&S(e.entries()).some((function(t){return!(t[1]instanceof G)})))throw new TypeError("modifiers must only contain Modifier instances");this[at]=e,this[at].forEach((function(t){t instanceof L&&!t.comparePoint?t.comparePoint=new B("=",r.max):t instanceof it&&!t.comparePoint&&(t.comparePoint=new B("=",r.min))}))}},{key:"max",get:function(){return this[lt]}},{key:"min",get:function(){return this[ct]}},{key:"name",get:function(){return"standard"}},{key:"notation",get:function(){var t="".concat(this.qty,"d").concat(this.sides);return this.modifiers&&this.modifiers.size&&(t+=S(this.modifiers.values()).reduce((function(t,e){return t+e.notation}),"")),t}},{key:"qty",get:function(){return this[ut]}},{key:"sides",get:function(){return this[st]}},{key:"roll",value:function(){for(var t=this,e=new nt,r=0;r<this.qty;r++)e.addRoll(this.rollOnce());return(this.modifiers||[]).forEach((function(r){r.run(e,t)})),e}},{key:"rollOnce",value:function(){return new et(I.integer(this.min,this.max))}},{key:"toJSON",value:function(){return{average:this.average,max:this.max,min:this.min,modifiers:this.modifiers,name:this.name,notation:this.notation,qty:this.qty,sides:this.sides,type:"die"}}},{key:"toString",value:function(){return this.notation}}]),t}(),ht=function(t){s(r,t);var e=v(r);function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;o(this,r);var a=t;if(a||0===a){if(1!==a&&2!==a)throw new RangeError("nonBlanks must be 1 or 2")}else a=2;return e.call(this,a,n,i,-1,1)}return a(r,[{key:"name",get:function(){return"fudge"}},{key:"nonBlanks",get:function(){return g(c(r.prototype),"sides",this)}},{key:"sides",get:function(){return"F.".concat(this.nonBlanks)}},{key:"rollOnce",value:function(){var t=0;if(2===this.nonBlanks)t=I.integer(1,3)-2;else if(1===this.nonBlanks){var e=I.integer(1,6);1===e?t=-1:6===e&&(t=1)}return new et(t)}}]),r}(ft),pt=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o(this,r),(t=e.call(this,100,n,i)).sidesAsNumber=!!a,t}return a(r,[{key:"name",get:function(){return"percentile"}},{key:"sides",get:function(){return this.sidesAsNumber?g(c(r.prototype),"sides",this):"%"}}]),r}(ft),yt=Object.freeze({__proto__:null,FudgeDice:ht,PercentileDice:pt,StandardDice:ft}),mt=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),(n=e.call(this,t)).order=9,n}return a(r,[{key:"name",get:function(){return"critical-failure"}},{key:"notation",get:function(){return"cf".concat(g(c(r.prototype),"notation",this))}},{key:"run",value:function(t,e){var r=this;return t.rolls.forEach((function(t){return r.isComparePoint(t.value)&&t.modifiers.add("critical-failure"),t})),t}}]),r}(U),vt=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),(n=e.call(this,t)).order=8,n}return a(r,[{key:"name",get:function(){return"critical-success"}},{key:"notation",get:function(){return"cs".concat(g(c(r.prototype),"notation",this))}},{key:"run",value:function(t,e){var r=this;return t.rolls.forEach((function(t){return r.isComparePoint(t.value)&&t.modifiers.add("critical-success"),t})),t}}]),r}(U),dt=Symbol("calculation-value"),gt=Symbol("is-roll-group"),bt=Symbol("modifiers"),wt=Symbol("results"),kt=Symbol("use-in-total"),St=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];o(this,t),this.isRollGroup=n,this.modifiers=r,this.results=e,this.useInTotal=i}return a(t,[{key:"calculationValue",get:function(){return P(this[dt])?parseFloat(this[dt]):this.value},set:function(t){var e=P(t);if(t===1/0)throw new RangeError("Results calculation value must be a finite number");if(t&&!e)throw new TypeError("Results calculation value is invalid: ".concat(t));this[dt]=e?parseFloat("".concat(t)):null}},{key:"isRollGroup",get:function(){return this[gt]},set:function(t){this[gt]=!!t}},{key:"length",get:function(){return this.results.length||0}},{key:"modifierFlags",get:function(){return H.apply(void 0,S(this.modifiers))}},{key:"modifiers",get:function(){return this[bt]},set:function(t){if((Array.isArray(t)||t instanceof Set)&&S(t).every((function(t){return"string"==typeof t})))this[bt]=new Set(S(t));else{if(t||0===t)throw new TypeError("modifiers must be a Set or array of modifier names: ".concat(t));this[bt]=new Set}}},{key:"results",get:function(){return S(this[wt])},set:function(t){var e=this;if(!t||!Array.isArray(t))throw new TypeError("results must be an array: ".concat(t));this[wt]=[],t.forEach((function(t){e.addResult(t)}))}},{key:"useInTotal",get:function(){return!!this[kt]},set:function(t){this[kt]=!!t}},{key:"value",get:function(){if(!this.results.length)return 0;var e=this.results.reduce((function(e,r){var n=r;return r instanceof t?n=r.useInTotal?r.calculationValue:0:r instanceof nt&&(n=r.value),e+n}),"string"==typeof this.results[0]?"":0);return"string"==typeof e?j(e):e}},{key:"addResult",value:function(e){var r;if(e instanceof t||e instanceof nt)r=e;else{if("string"!=typeof e&&!P(e))throw new TypeError("value must be one of ResultGroup, RollResults, string, or number");r=e}this[wt].push(r)}},{key:"toJSON",value:function(){var t=this.calculationValue,e=this.isRollGroup,r=this.modifierFlags,n=this.modifiers,o=this.results,i=this.useInTotal,a=this.value;return{calculationValue:t,isRollGroup:e,modifierFlags:r,modifiers:S(n),results:o,type:"result-group",useInTotal:i,value:a}}},{key:"toString",value:function(){var t;return t=this.isRollGroup?"{".concat(this.results.join(", "),"}"):this.results.join(""),this.modifierFlags&&(t="(".concat(t,")").concat(this.modifierFlags)),t}}]),t}(),At=Symbol("end"),Et=Symbol("qty"),xt=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"h",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return o(this,r),(t=e.call(this)).end=n,t.qty=i,t.order=5,t}return a(r,[{key:"end",get:function(){return this[At]},set:function(t){if("h"!==t&&"l"!==t)throw new RangeError('End must be "h" or "l"');this[At]=t}},{key:"name",get:function(){return"keep-".concat(this.end)}},{key:"notation",get:function(){return"k".concat(this.end).concat(this.qty)}},{key:"qty",get:function(){return this[Et]},set:function(t){if(t===1/0)throw new RangeError("qty must be a finite number");if(!P(t)||t<1)throw new TypeError("qty must be a positive finite integer");this[Et]=Math.floor(t)}},{key:"rangeToDrop",value:function(t){return"h"===this.end?[0,t.length-this.qty]:[this.qty,t.length]}},{key:"run",value:function(t,e){var r,n,o;return(o=(r=(o=t instanceof St?1===(n=t.results).length&&n[0]instanceof St?n[0].results.map((function(t,e){return t instanceof nt?t.rolls.map((function(t,r){return{value:t.value,index:[e,r]}})):null})).flat().filter(Boolean):S(n).map((function(t,e){return{value:t.value,index:e}})):S(n=t.rolls).map((function(t,e){return{value:t.value,index:e}}))).sort((function(t,e){return t.value-e.value})).map((function(t){return t.index}))).slice.apply(r,S(this.rangeToDrop(o)))).forEach((function(t){var e;(e=Array.isArray(t)?n[0].results[t[0]].rolls[t[1]]:n[t]).modifiers.add("drop"),e.useInTotal=!1})),t}},{key:"toJSON",value:function(){var t=this.end,e=this.qty;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{end:t,qty:e})}}]),r}(G),Ot=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"l",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return o(this,r),(t=e.call(this,n,i)).order=6,t}return a(r,[{key:"name",get:function(){return"drop-".concat(this.end)}},{key:"notation",get:function(){return"d".concat(this.end).concat(this.qty)}},{key:"rangeToDrop",value:function(t){return"h"===this.end?[t.length-this.qty,t.length]:[0,this.qty]}}]),r}(xt),Tt=Symbol("max"),Ct=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),(n=e.call(this)).max=t,n.order=2,n}return a(r,[{key:"max",get:function(){return this[Tt]},set:function(t){if(!P(t))throw new TypeError("max must be a number");this[Tt]=parseFloat("".concat(t))}},{key:"name",get:function(){return"max"}},{key:"notation",get:function(){return"max".concat(this.max)}},{key:"run",value:function(t,e){var r=this,n=t;return n.rolls=t.rolls.map((function(t){var e=t;return t.value>r.max&&(e.value=r.max,e.modifiers.add("max")),e})),n}},{key:"toJSON",value:function(){var t=this.max;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{max:t})}}]),r}(G),Rt=Symbol("min"),Nt=function(t){s(r,t);var e=v(r);function r(t){var n;return o(this,r),(n=e.call(this)).min=t,n.order=1,n}return a(r,[{key:"min",get:function(){return this[Rt]},set:function(t){if(!P(t))throw new TypeError("min must be a number");this[Rt]=parseFloat("".concat(t))}},{key:"name",get:function(){return"min"}},{key:"notation",get:function(){return"min".concat(this.min)}},{key:"run",value:function(t,e){var r=this,n=t;return n.rolls=t.rolls.map((function(t){var e=t;return t.value<r.min&&(e.value=r.min,e.modifiers.add("min")),e})),n}},{key:"toJSON",value:function(){var t=this.min;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{min:t})}}]),r}(G),jt=Symbol("direction"),Pt=function(t){s(r,t);var e=v(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"a";return o(this,r),(t=e.call(this)).direction=n,t.order=10,t}return a(r,[{key:"direction",get:function(){return this[jt]},set:function(t){if("a"!==t&&"d"!==t)throw new RangeError('Direction must be "a" (Ascending) or "d" (Descending)');this[jt]=t}},{key:"name",get:function(){return"sorting"}},{key:"notation",get:function(){return"s".concat(this.direction)}},{key:"run",value:function(t,e){var r,n=this;return t[r=t instanceof St?"results":"rolls"]=t[r].sort((function(t,e){return"d"===n.direction?e.value-t.value:t.value-e.value})),t instanceof St&&(t[r]=t[r].map((function(t){return t instanceof St||t instanceof nt?n.run(t,e):t}))),t}},{key:"toJSON",value:function(){var t=this.direction;return Object.assign(g(c(r.prototype),"toJSON",this).call(this),{direction:t})}}]),r}(G),Mt=Symbol("failure-cp"),Ft=function(t){s(r,t);var e=v(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return o(this,r),(n=e.call(this,t)).failureComparePoint=i,n.order=7,n}return a(r,[{key:"failureComparePoint",get:function(){return this[Mt]},set:function(t){if(t&&!(t instanceof B))throw new TypeError("failure comparePoint must be instance of ComparePoint or null");this[Mt]=t||null}},{key:"name",get:function(){return"target"}},{key:"notation",get:function(){return"".concat(g(c(r.prototype),"notation",this)).concat(this.failureComparePoint?"f".concat(this.failureComparePoint):"")}},{key:"successComparePoint",get:function(){return this.comparePoint},set:function(t){w(c(r.prototype),"comparePoint",t,this,!0)}},{key:"getStateValue",value:function(t){return this.isSuccess(t)?1:this.isFailure(t)?-1:0}},{key:"isFailure",value:function(t){return!!this.failureComparePoint&&this.failureComparePoint.isMatch(t)}},{key:"isNeutral",value:function(t){return!this.isSuccess(t)&&!this.isFailure(t)}},{key:"isSuccess",value:function(t){return this.isComparePoint(t)}},{key:"run",value:function(t,e){var r=this;return(t instanceof St?t.results:t.rolls).forEach((function(t){r.isSuccess(t.value)?t.modifiers.add("target-success"):r.isFailure(t.value)&&t.modifiers.add("target-failure"),t.calculationValue=r.getStateValue(t.value)})),t}},{key:"toJSON",value:function(){var t=this.failureComparePoint,e=this.successComparePoint,n=g(c(r.prototype),"toJSON",this).call(this);return delete n.comparePoint,Object.assign(n,{failureComparePoint:t,successComparePoint:e})}}]),r}(U),Jt=Object.freeze({__proto__:null,ComparisonModifier:U,CriticalFailureModifier:mt,CriticalSuccessModifier:vt,DropModifier:Ot,ExplodeModifier:L,KeepModifier:xt,MaxModifier:Ct,MinModifier:Nt,Modifier:G,ReRollModifier:it,SortingModifier:Pt,TargetModifier:Ft}),_t=Object.freeze({__proto__:null,ResultGroup:St,RollResult:et,RollResults:nt}),It=function(t){try{return!(!t||btoa(atob(t))!==t)}catch(t){return!1}},qt=function(t){try{var e=!!t&&JSON.parse(t);return!(!e||"object"!==n(e))}catch(t){return!1}},Vt=Symbol("modifiers"),Dt=Symbol("expressions"),Bt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];o(this,t),this.expressions=e,this.modifiers=r}return a(t,[{key:"expressions",get:function(){return S(this[Dt]||[])},set:function(t){var e=this;if(!t)throw new R("expressions");if(!Array.isArray(t))throw new TypeError("expressions must be an array: ".concat(t));this[Dt]=[],t.forEach((function(r){if(!r||!Array.isArray(r))throw new TypeError("Expressions must be an array of arrays: ".concat(t));if(0===r.length)throw new TypeError("Sub expressions cannot be empty: ".concat(t));if(!r.every((function(t){return t instanceof ft||"string"==typeof t||"number"==typeof t})))throw new TypeError("Sub expression items must be Dice, numbers, or strings");e[Dt].push(r)}))}},{key:"modifiers",get:function(){return this[Vt]?new Map(S(this[Vt]).sort((function(t,e){return t[1].order-e[1].order}))):null},set:function(t){var e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((function(t){return[t.name,t]})));else{if("object"!==n(t))throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&S(e.entries()).some((function(t){return!(t[1]instanceof G)})))throw new TypeError("modifiers must only contain Modifier instances");this[Vt]=e}},{key:"notation",get:function(){var t=this.expressions.map((function(t){return t.reduce((function(t,e){return t+e}),"")})).join(", ");return t="{".concat(t,"}"),this.modifiers&&this.modifiers.size&&(t+=S(this.modifiers.values()).reduce((function(t,e){return t+e.notation}),"")),t}},{key:"roll",value:function(){var t=this,e=new St(this.expressions.map((function(t){var e=t.map((function(t){return t instanceof ft?t.roll():t}));return new St(e)})));return e.isRollGroup=!0,(this.modifiers||[]).forEach((function(r){r.run(e,t)})),e}},{key:"toJSON",value:function(){var t=this.modifiers,e=this.notation;return{expressions:this.expressions,modifiers:t,notation:e,type:"group"}}},{key:"toString",value:function(){return this.notation}}]),t}();function Gt(t,e,r,n){this.message=t,this.expected=e,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,Gt)}function zt(t,e){e=void 0!==e?e:{};var r,n,o,i,a={},s={Main:be},c=be,l=ye("{",!1),f=",",h=ye(",",!1),p=ye("}",!1),y="d",m=ye("d",!1),v="d%",d=ye("d%",!1),g="dF",b=ye("dF",!1),w=ye(".",!1),A=/^[12]/,E=me(["1","2"],!1,!1),x="!",O=ye("!",!1),T=ye("p",!1),C=/^[lh]/,R=me(["l","h"],!1,!1),N=ye("k",!1),P="max",M=ye("max",!1),F="min",J=ye("min",!1),_=ye("r",!1),I=ye("o",!1),q="cs",V=ye("cs",!1),D="cf",G=ye("cf",!1),z=ye("s",!1),U=ye("a",!1),$=ye("f",!1),K="!=",X=ye("!=",!1),H="<=",Q=ye("<=",!1),W=">=",Y=ye(">=",!1),Z=ye("=",!1),tt=ye(">",!1),et=ye("<",!1),rt="(",nt=ye("(",!1),ot=")",at=ye(")",!1),ut="abs",st=ye("abs",!1),ct="ceil",lt=ye("ceil",!1),yt="cos",dt=ye("cos",!1),gt="exp",bt=ye("exp",!1),wt="floor",kt=ye("floor",!1),St="log",At=ye("log",!1),Et="round",Tt=ye("round",!1),Rt="sign",jt=ye("sign",!1),Mt="sin",Jt=ye("sin",!1),_t="sqrt",It=ye("sqrt",!1),qt="tan",Vt=ye("tan",!1),Dt="pow",zt=ye("pow",!1),Ut=ye("-",!1),$t=/^[.]/,Kt=me(["."],!1,!1),Lt=/^[1-9]/,Xt=me([["1","9"]],!1,!1),Ht=/^[0-9]/,Qt=me([["0","9"]],!1,!1),Wt=function(){return parseInt(pe(),10)},Yt=ye("**",!1),Zt=ye("*",!1),te=ye("^",!1),ee=ye("%",!1),re=ye("/",!1),ne=ye("+",!1),oe={type:"other",description:"whitespace"},ie=/^[ \t\n\r]/,ae=me([" ","\t","\n","\r"],!1,!1),ue=0,se=0,ce=[{line:1,column:1}],le=0,fe=[],he=0;if("startRule"in e){if(!(e.startRule in s))throw new Error("Can't start parsing from rule \""+e.startRule+'".');c=s[e.startRule]}function pe(){return t.substring(se,ue)}function ye(t,e){return{type:"literal",text:t,ignoreCase:e}}function me(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ve(e){var r,n=ce[e];if(n)return n;for(r=e-1;!ce[r];)r--;for(n={line:(n=ce[r]).line,column:n.column};r<e;)10===t.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return ce[e]=n,n}function de(t,e){var r=ve(t),n=ve(e);return{start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function ge(t){ue<le||(ue>le&&(le=ue,fe=[]),fe.push(t))}function be(){return xe()}function we(){var e,r,n,o,i,s,c,f,y,m;if(e=ue,123===t.charCodeAt(ue)?(r="{",ue++):(r=a,0===he&&ge(l)),r!==a)if(je()!==a)if((n=xe())!==a){for(o=[],i=ue,(s=je())!==a?(44===t.charCodeAt(ue)?(c=",",ue++):(c=a,0===he&&ge(h)),c!==a&&(f=je())!==a&&(y=xe())!==a?i=s=[s,c,f,y]:(ue=i,i=a)):(ue=i,i=a);i!==a;)o.push(i),i=ue,(s=je())!==a?(44===t.charCodeAt(ue)?(c=",",ue++):(c=a,0===he&&ge(h)),c!==a&&(f=je())!==a&&(y=xe())!==a?i=s=[s,c,f,y]:(ue=i,i=a)):(ue=i,i=a);if(o!==a)if((i=je())!==a)if(125===t.charCodeAt(ue)?(s="}",ue++):(s=a,0===he&&ge(p)),s!==a){for(c=[],f=Se();f!==a;)c.push(f),f=Se();c!==a?(se=e,m=c,e=r=new Bt([n].concat(S(o.map((function(t){return t[3]})))),Object.assign.apply(Object,[{}].concat(S(m.map((function(t){return u({},t.name,t)}))))))):(ue=e,e=a)}else ue=e,e=a;else ue=e,e=a;else ue=e,e=a}else ue=e,e=a;else ue=e,e=a;else ue=e,e=a;return e}function ke(){var e,r,n,o,i,s;if(e=ue,(r=function(){var e,r,n,o;e=ue,(r=Ee())===a&&(r=null);r!==a?(100===t.charCodeAt(ue)?(n=y,ue++):(n=a,0===he&&ge(m)),n!==a&&(o=Ee())!==a?(se=e,e=r=new ft(o,r||1)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(r=function(){var e,r,n;e=ue,(r=Ee())===a&&(r=null);r!==a?(t.substr(ue,2)===v?(n=v,ue+=2):(n=a,0===he&&ge(d)),n!==a?(se=e,e=r=new pt(r||1)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(r=function(){var e,r,n,o,i,u;e=ue,(r=Ee())===a&&(r=null);r!==a?(t.substr(ue,2)===g?(n=g,ue+=2):(n=a,0===he&&ge(b)),n!==a?(o=ue,46===t.charCodeAt(ue)?(i=".",ue++):(i=a,0===he&&ge(w)),i!==a?(A.test(t.charAt(ue))?(u=t.charAt(ue),ue++):(u=a,0===he&&ge(E)),u!==a?o=i=[i,u]:(ue=o,o=a)):(ue=o,o=a),o===a&&(o=null),o!==a?(se=e,s=r,e=r=new ht((c=o)?parseInt(c[1],10):2,s||1)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a);var s,c;return e}()),r!==a){for(n=[],o=Se();o!==a;)n.push(o),o=Se();n!==a?(se=e,s=n,(i=r).modifiers=Object.assign.apply(Object,[{}].concat(S(s.map((function(t){return u({},t.name,t)}))))),e=r=i):(ue=e,e=a)}else ue=e,e=a;return e}function Se(){var e;return(e=function(){var e,r,n,o,i;e=ue,33===t.charCodeAt(ue)?(r=x,ue++):(r=a,0===he&&ge(O));r!==a?(33===t.charCodeAt(ue)?(n=x,ue++):(n=a,0===he&&ge(O)),n===a&&(n=null),n!==a?(112===t.charCodeAt(ue)?(o="p",ue++):(o=a,0===he&&ge(T)),o===a&&(o=null),o!==a?((i=Ae())===a&&(i=null),i!==a?(se=e,e=r=new L(i,!!n,!!o)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,(r=Ae())!==a?((n=function(){var e,r,n;e=ue,102===t.charCodeAt(ue)?(r="f",ue++):(r=a,0===he&&ge($));r!==a&&(n=Ae())!==a?(se=e,e=r=n):(ue=e,e=a);return e}())===a&&(n=null),n!==a?(se=e,e=r=new Ft(r,n)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n,o;e=ue,100===t.charCodeAt(ue)?(r=y,ue++):(r=a,0===he&&ge(m));r!==a?(C.test(t.charAt(ue))?(n=t.charAt(ue),ue++):(n=a,0===he&&ge(R)),n===a&&(n=null),n!==a&&(o=Ce())!==a?(se=e,e=r=new Ot(n||"l",o)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n,o;e=ue,107===t.charCodeAt(ue)?(r="k",ue++):(r=a,0===he&&ge(N));r!==a?(C.test(t.charAt(ue))?(n=t.charAt(ue),ue++):(n=a,0===he&&ge(R)),n===a&&(n=null),n!==a&&(o=Ce())!==a?(se=e,e=r=new xt(n||"h",o)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n,o;e=ue,114===t.charCodeAt(ue)?(r="r",ue++):(r=a,0===he&&ge(_));r!==a?(111===t.charCodeAt(ue)?(n="o",ue++):(n=a,0===he&&ge(I)),n===a&&(n=null),n!==a?((o=Ae())===a&&(o=null),o!==a?(se=e,e=r=new it(!!n,o)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,t.substr(ue,2)===q?(r=q,ue+=2):(r=a,0===he&&ge(V));r!==a&&(n=Ae())!==a?(se=e,e=r=new vt(n)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,t.substr(ue,2)===D?(r=D,ue+=2):(r=a,0===he&&ge(G));r!==a&&(n=Ae())!==a?(se=e,e=r=new mt(n)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,115===t.charCodeAt(ue)?(r="s",ue++):(r=a,0===he&&ge(z));r!==a?(97===t.charCodeAt(ue)?(n="a",ue++):(n=a,0===he&&ge(U)),n===a&&(100===t.charCodeAt(ue)?(n=y,ue++):(n=a,0===he&&ge(m))),n===a&&(n=null),n!==a?(se=e,e=r=new Pt(n||"a")):(ue=e,e=a)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,t.substr(ue,3)===P?(r=P,ue+=3):(r=a,0===he&&ge(M));r!==a&&(n=Te())!==a?(se=e,e=r=new Ct(n)):(ue=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ue,t.substr(ue,3)===F?(r=F,ue+=3):(r=a,0===he&&ge(J));r!==a&&(n=Te())!==a?(se=e,e=r=new Nt(n)):(ue=e,e=a);return e}()),e}function Ae(){var e,r,n;return e=ue,(r=function(){var e;t.substr(ue,2)===K?(e=K,ue+=2):(e=a,0===he&&ge(X));e===a&&(t.substr(ue,2)===H?(e=H,ue+=2):(e=a,0===he&&ge(Q)),e===a&&(t.substr(ue,2)===W?(e=W,ue+=2):(e=a,0===he&&ge(Y)),e===a&&(61===t.charCodeAt(ue)?(e="=",ue++):(e=a,0===he&&ge(Z)),e===a&&(62===t.charCodeAt(ue)?(e=">",ue++):(e=a,0===he&&ge(tt)),e===a&&(60===t.charCodeAt(ue)?(e="<",ue++):(e=a,0===he&&ge(et)))))));return e}())!==a&&(n=Te())!==a?(se=e,e=r=new B(r,n)):(ue=e,e=a),e}function Ee(){var e,r,n,o,i,u,s,c,l,f;if((e=Ce())===a)if(e=ue,40===t.charCodeAt(ue)?(r=rt,ue++):(r=a,0===he&&ge(nt)),r!==a)if(je()!==a){if(n=ue,(o=Te())!==a){if(i=[],u=ue,(s=je())!==a&&(c=Ne())!==a&&(l=je())!==a&&(f=Te())!==a?u=s=[s,c,l,f]:(ue=u,u=a),u!==a)for(;u!==a;)i.push(u),u=ue,(s=je())!==a&&(c=Ne())!==a&&(l=je())!==a&&(f=Te())!==a?u=s=[s,c,l,f]:(ue=u,u=a);else i=a;i!==a?n=o=[o,i]:(ue=n,n=a)}else ue=n,n=a;n!==a&&(o=je())!==a?(41===t.charCodeAt(ue)?(i=ot,ue++):(i=a,0===he&&ge(at)),i!==a?(se=e,e=r=j(pe())):(ue=e,e=a)):(ue=e,e=a)}else ue=e,e=a;else ue=e,e=a;return e}function xe(){var t,e,r,n,o,i,u,s,c,l;if(t=ue,(e=Oe())!==a){for(r=[],n=ue,(o=je())!==a&&(i=Ne())!==a&&(u=je())!==a&&(s=Oe())!==a?n=o=[o,i,u,s]:(ue=n,n=a);n!==a;)r.push(n),n=ue,(o=je())!==a&&(i=Ne())!==a&&(u=je())!==a&&(s=Oe())!==a?n=o=[o,i,u,s]:(ue=n,n=a);r!==a?(se=t,c=e,l=r,c=Array.isArray(c)?c:[c],t=e=[].concat(S(c),S(l.map((function(t){var e=k(t,4);return[e[1],e[3]]})).flat(2)))):(ue=t,t=a)}else ue=t,t=a;return t}function Oe(){var e,r,n,o,i;return(e=function(){var e,r,n,o,i,u,s;e=ue,t.substr(ue,3)===ut?(r=ut,ue+=3):(r=a,0===he&&ge(st));r===a&&(t.substr(ue,4)===ct?(r=ct,ue+=4):(r=a,0===he&&ge(lt)),r===a&&(t.substr(ue,3)===yt?(r=yt,ue+=3):(r=a,0===he&&ge(dt)),r===a&&(t.substr(ue,3)===gt?(r=gt,ue+=3):(r=a,0===he&&ge(bt)),r===a&&(t.substr(ue,5)===wt?(r=wt,ue+=5):(r=a,0===he&&ge(kt)),r===a&&(t.substr(ue,3)===St?(r=St,ue+=3):(r=a,0===he&&ge(At)),r===a&&(t.substr(ue,5)===Et?(r=Et,ue+=5):(r=a,0===he&&ge(Tt)),r===a&&(t.substr(ue,4)===Rt?(r=Rt,ue+=4):(r=a,0===he&&ge(jt)),r===a&&(t.substr(ue,3)===Mt?(r=Mt,ue+=3):(r=a,0===he&&ge(Jt)),r===a&&(t.substr(ue,4)===_t?(r=_t,ue+=4):(r=a,0===he&&ge(It)),r===a&&(t.substr(ue,3)===qt?(r=qt,ue+=3):(r=a,0===he&&ge(Vt))))))))))));r!==a?(40===t.charCodeAt(ue)?(n=rt,ue++):(n=a,0===he&&ge(nt)),n!==a&&je()!==a&&(o=xe())!==a&&je()!==a?(41===t.charCodeAt(ue)?(i=ot,ue++):(i=a,0===he&&ge(at)),i!==a?(se=e,c=o,e=r=["".concat(r,"(")].concat(S(c),[")"])):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a);var c;e===a&&(e=ue,t.substr(ue,3)===Dt?(r=Dt,ue+=3):(r=a,0===he&&ge(zt)),r===a&&(t.substr(ue,3)===P?(r=P,ue+=3):(r=a,0===he&&ge(M)),r===a&&(t.substr(ue,3)===F?(r=F,ue+=3):(r=a,0===he&&ge(J)))),r!==a?(40===t.charCodeAt(ue)?(n=rt,ue++):(n=a,0===he&&ge(nt)),n!==a&&je()!==a&&(o=xe())!==a&&je()!==a?(44===t.charCodeAt(ue)?(i=f,ue++):(i=a,0===he&&ge(h)),i!==a&&je()!==a&&(u=xe())!==a&&je()!==a?(41===t.charCodeAt(ue)?(s=ot,ue++):(s=a,0===he&&ge(at)),s!==a?(se=e,e=r=function(t,e,r){return["".concat(t,"(")].concat(S(e),[","],S(r),[")"])}(r,o,u)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a)):(ue=e,e=a));return e}())===a&&(e=ke())===a&&(e=Te())===a&&(e=ue,40===t.charCodeAt(ue)?(r=rt,ue++):(r=a,0===he&&ge(nt)),r!==a&&je()!==a&&(n=xe())!==a&&je()!==a?(41===t.charCodeAt(ue)?(o=ot,ue++):(o=a,0===he&&ge(at)),o!==a?(se=e,i=o,e=r=[r].concat(S(n),[i])):(ue=e,e=a)):(ue=e,e=a),e===a&&(e=we())),e}function Te(){var e,r,n,o,i;return e=ue,45===t.charCodeAt(ue)?(r="-",ue++):(r=a,0===he&&ge(Ut)),r===a&&(r=null),r!==a&&Re()!==a?(n=ue,$t.test(t.charAt(ue))?(o=t.charAt(ue),ue++):(o=a,0===he&&ge(Kt)),o!==a&&(i=Re())!==a?n=o=[o,i]:(ue=n,n=a),n===a&&(n=null),n!==a?(se=e,e=r=parseFloat(pe())):(ue=e,e=a)):(ue=e,e=a),e}function Ce(){var e,r,n,o;if(e=ue,Lt.test(t.charAt(ue))?(r=t.charAt(ue),ue++):(r=a,0===he&&ge(Xt)),r!==a){for(n=[],Ht.test(t.charAt(ue))?(o=t.charAt(ue),ue++):(o=a,0===he&&ge(Qt));o!==a;)n.push(o),Ht.test(t.charAt(ue))?(o=t.charAt(ue),ue++):(o=a,0===he&&ge(Qt));n!==a?(se=e,e=r=Wt()):(ue=e,e=a)}else ue=e,e=a;return e}function Re(){var e,r,n;if(e=ue,r=[],Ht.test(t.charAt(ue))?(n=t.charAt(ue),ue++):(n=a,0===he&&ge(Qt)),n!==a)for(;n!==a;)r.push(n),Ht.test(t.charAt(ue))?(n=t.charAt(ue),ue++):(n=a,0===he&&ge(Qt));else r=a;return r!==a&&(se=e,r=Wt()),e=r}function Ne(){var e,r;return e=ue,"**"===t.substr(ue,2)?(r="**",ue+=2):(r=a,0===he&&ge(Yt)),r!==a&&(se=e,r="^"),(e=r)===a&&(42===t.charCodeAt(ue)?(e="*",ue++):(e=a,0===he&&ge(Zt)),e===a&&(94===t.charCodeAt(ue)?(e="^",ue++):(e=a,0===he&&ge(te)),e===a&&(37===t.charCodeAt(ue)?(e="%",ue++):(e=a,0===he&&ge(ee)),e===a&&(47===t.charCodeAt(ue)?(e="/",ue++):(e=a,0===he&&ge(re)),e===a&&(43===t.charCodeAt(ue)?(e="+",ue++):(e=a,0===he&&ge(ne)),e===a&&(45===t.charCodeAt(ue)?(e="-",ue++):(e=a,0===he&&ge(Ut)))))))),e}function je(){var e,r;for(he++,e=[],ie.test(t.charAt(ue))?(r=t.charAt(ue),ue++):(r=a,0===he&&ge(ae));r!==a;)e.push(r),ie.test(t.charAt(ue))?(r=t.charAt(ue),ue++):(r=a,0===he&&ge(ae));return he--,e===a&&(r=a,0===he&&ge(oe)),e}if((r=c())!==a&&ue===t.length)return r;throw r!==a&&ue<t.length&&ge({type:"end"}),n=fe,o=le<t.length?t.charAt(le):null,i=le<t.length?de(le,le+1):de(le,le),new Gt(Gt.buildMessage(n,o),n,o,i)}!function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}(Gt,Error),Gt.buildMessage=function(t,e){var r={literal:function(t){return'"'+o(t.text)+'"'},class:function(t){var e=t.parts.map((function(t){return Array.isArray(t)?i(t[0])+"-"+i(t[1]):i(t)}));return"["+(t.inverted?"^":"")+e+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}function o(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function i(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function a(t){return r[t.type](t)}return"Expected "+function(t){var e,r,n=t.map(a);if(n.sort(),n.length>0){for(e=1,r=1;e<n.length;e++)n[e-1]!==n[e]&&(n[r]=n[e],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+o(t)+'"':"end of input"}(e)+" found."};var Ut=function(){function t(){o(this,t)}return a(t,null,[{key:"parse",value:function(t){if(!t)throw new R("notation");if("string"!=typeof t)throw new TypeError("Notation must be a string");return zt(t)}}]),t}(),$t=Object.freeze({BASE_64:1,JSON:0,OBJECT:2}),Kt=Symbol("notation"),Lt=Symbol("maxTotal"),Xt=Symbol("minTotal"),Ht=Symbol("expressions"),Qt=Symbol("roll-method"),Wt=Symbol("rolls"),Yt=Symbol("set-rolls"),Zt=Symbol("total"),te=function(t){return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return parseFloat(parseFloat("".concat(t)).toFixed(e||0))}(t.calculationValue,2)},ee=function(){function t(e){if(o(this,t),!e)throw new R("notation");if(this[Ht]=[],e instanceof Object&&!Array.isArray(e)){if(!e.notation)throw new R("notation");if("string"!=typeof e.notation)throw new C(e.notation);e.rolls&&this[Yt](e.rolls),this[Kt]=e.notation,this[Ht]=Ut.parse(this.notation),this.hasRolls()||this.roll()}else{if("string"!=typeof e)throw new C(e);this[Kt]=e,this[Ht]=Ut.parse(this.notation),this.roll()}}return a(t,[{key:"averageTotal",get:function(){return(this.maxTotal+this.minTotal)/2}},{key:"maxTotal",get:function(){if(!this.hasExpressions())return 0;if(!this[Lt]){var t=this[Qt](_.max);this[Lt]=te(t)}return this[Lt]}},{key:"minTotal",get:function(){if(!this.hasExpressions())return 0;if(!this[Xt]){var t=this[Qt](_.min);this[Xt]=te(t)}return this[Xt]}},{key:"notation",get:function(){return this[Kt]}},{key:"output",get:function(){var t="".concat(this.notation,": ");return this.hasRolls()?t+="".concat(this[Wt]," = ").concat(this.total):t+="No dice rolled",t}},{key:"rolls",get:function(){return this[Wt]?this[Wt].results:[]}},{key:"total",get:function(){return!this[Zt]&&this.hasRolls()&&(this[Zt]=te(this[Wt])),this[Zt]||0}},{key:"export",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$t.JSON;switch(t){case $t.BASE_64:return btoa(this.export($t.JSON));case $t.JSON:return JSON.stringify(this);case $t.OBJECT:return JSON.parse(this.export($t.JSON));default:throw new TypeError('Invalid export format "'.concat(t,'"'))}}},{key:"hasExpressions",value:function(){return this[Ht]&&this[Ht].length>0}},{key:"hasRolls",value:function(){return this.hasExpressions()&&this.rolls.length>0}},{key:"roll",value:function(){return this[Zt]=0,this[Wt]=this[Qt](),this.rolls}},{key:"toJSON",value:function(){return{averageTotal:this.averageTotal,maxTotal:this.maxTotal,minTotal:this.minTotal,notation:this.notation,output:this.output,rolls:this.rolls,total:this.total,type:"dice-roll"}}},{key:"toString",value:function(){return this.output}},{key:Qt,value:function(t){var e;t&&(e=I.engine,I.engine=t);var r=new St(this[Ht].map((function(t){return t instanceof ft||t instanceof Bt?t.roll():t})).filter((function(t){return!!t||0===t})));return t&&(I.engine=e),r}},{key:Yt,value:function(t){if(t instanceof St)this[Wt]=t;else if(t instanceof nt)this[Wt]=new St([t]);else{if(!Array.isArray(t))throw new TypeError("Rolls must be a valid result object, or an array");this[Wt]=new St(t.map((function(t){if(t instanceof St||t instanceof nt)return t;if(Array.isArray(t))return new nt(t);if("object"===n(t)){if(Array.isArray(t.results))return new St(t.results,t.modifiers||[],t.isRollGroup||!1,"boolean"!=typeof t.useInTotal||t.useInTotal);if(Array.isArray(t.rolls))return new nt(t.rolls)}return t})))}}}],[{key:"import",value:function(e){if(e){if(qt(e))return t.import(JSON.parse(e));if(It(e))return t.import(atob(e));if("object"===n(e))return new t(e);throw new O(e)}throw new R("data")}}]),t}(),re=Symbol("log"),ne=function(){function t(e){o(this,t),this[re]=[],e&&this.import(e)}return a(t,[{key:"log",get:function(){return this[re]||[]}},{key:"output",get:function(){return this.log.join("; ")}},{key:"total",get:function(){return this.log.reduce((function(t,e){return t+e.total}),0)}},{key:"clearLog",value:function(){this[re].length=0}},{key:"export",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$t.JSON;switch(t){case $t.BASE_64:return btoa(this.export($t.JSON));case $t.JSON:return JSON.stringify(this);case $t.OBJECT:return JSON.parse(this.export($t.JSON));default:throw new TypeError('Invalid export format "'.concat(t,'"'))}}},{key:"import",value:function(t){var e=this;if(t){if(qt(t))return this.import(JSON.parse(t));if(It(t))return this.import(atob(t));if("object"===n(t)){var r=t.log||null;if(!t.log&&Array.isArray(t)&&t.length&&(r=t),r&&Array.isArray(r))r.forEach((function(t){e[re].push(ee.import(t))}));else if(r)throw new TypeError("log must be an array");return this.log}throw new O(t)}throw new R("data")}},{key:"roll",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var o=r.filter(Boolean);if(0===o.length)throw new R("notations");var i=o.map((function(e){var r=new ee(e);return t[re].push(r),r}));return i.length>1?i:i[0]}},{key:"toJSON",value:function(){return{log:this.log,output:this.output,total:this.total,type:"dice-roller"}}},{key:"toString",value:function(){return this.output}}],[{key:"import",value:function(e){var r=new t;return r.import(e),r}}]),t}();t.ComparePoint=B,t.Dice=yt,t.DiceRoll=ee,t.DiceRoller=ne,t.Exceptions=N,t.Modifiers=Jt,t.NumberGenerator=q,t.Parser=Ut,t.Results=_t,t.RollGroup=Bt,t.exportFormats=$t,Object.defineProperty(t,"__esModule",{value:!0})}));
